# ==================== TradeMaster Backend Makefile ====================
# åç«¯ç‰¹å®šçš„ç®¡ç†å‘½ä»¤

# ç¯å¢ƒå˜é‡
.PHONY: help install dev test lint format clean migrate db-* docker-*
.DEFAULT_GOAL := help

# é¢œè‰²å®šä¹‰
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
BLUE := \033[34m
RESET := \033[0m

# Pythonç›¸å…³é…ç½®
PYTHON := python
PIP := pip
VENV := venv
VENV_ACTIVATE := $(VENV)/bin/activate

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Linux)
    PLATFORM := linux
endif
ifeq ($(UNAME_S),Darwin)
    PLATFORM := macos
endif
ifdef OS
    ifeq ($(OS),Windows_NT)
        PLATFORM := windows
        VENV_ACTIVATE := $(VENV)/Scripts/activate
        PYTHON := python
    endif
endif

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "$(GREEN)TradeMaster Backend Commands$(RESET)"
	@echo "$(BLUE)å¯ç”¨å‘½ä»¤:$(RESET)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(RESET) %s\n", $$1, $$2}'

# ==================== ç¯å¢ƒç®¡ç† ====================
install: ## ğŸ”§ å®‰è£…æ‰€æœ‰ä¾èµ–
	@echo "$(GREEN)ğŸ”§ å®‰è£…åç«¯ä¾èµ–...$(RESET)"
	$(PYTHON) -m pip install --upgrade pip setuptools wheel
	$(PIP) install -r requirements.txt
	@if [ -f requirements-dev.txt ]; then $(PIP) install -r requirements-dev.txt; fi
	@echo "$(GREEN)âœ… ä¾èµ–å®‰è£…å®Œæˆ$(RESET)"

install-dev: ## ğŸ› ï¸ å®‰è£…å¼€å‘ä¾èµ–
	@echo "$(BLUE)ğŸ› ï¸ å®‰è£…å¼€å‘ä¾èµ–...$(RESET)"
	$(PIP) install -r requirements-dev.txt
	$(PIP) install pre-commit black isort flake8 mypy bandit safety
	@echo "$(GREEN)âœ… å¼€å‘ä¾èµ–å®‰è£…å®Œæˆ$(RESET)"

setup: ## ğŸš€ åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
	@echo "$(GREEN)ğŸš€ åˆå§‹åŒ–åç«¯å¼€å‘ç¯å¢ƒ...$(RESET)"
	$(PYTHON) scripts/setup.py
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ$(RESET)"

venv: ## ğŸ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
	@echo "$(BLUE)ğŸ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...$(RESET)"
	$(PYTHON) -m venv $(VENV)
	@echo "$(GREEN)âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ$(RESET)"
	@echo "$(YELLOW)æ¿€æ´»å‘½ä»¤: source $(VENV_ACTIVATE)$(RESET)"

# ==================== å¼€å‘æœåŠ¡ ====================
dev: ## ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨
	@echo "$(GREEN)ğŸš€ å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨...$(RESET)"
	$(PYTHON) scripts/dev.py

dev-debug: ## ğŸ› å¯åŠ¨è°ƒè¯•æ¨¡å¼æœåŠ¡å™¨
	@echo "$(BLUE)ğŸ› å¯åŠ¨è°ƒè¯•æ¨¡å¼æœåŠ¡å™¨...$(RESET)"
	$(PYTHON) scripts/dev.py --debug

dev-prod: ## ğŸŒŸ ä½¿ç”¨ç”Ÿäº§é…ç½®å¯åŠ¨
	@echo "$(GREEN)ğŸŒŸ ä½¿ç”¨ç”Ÿäº§é…ç½®å¯åŠ¨...$(RESET)"
	gunicorn app.main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

run: ## â–¶ï¸ ç›´æ¥è¿è¡Œåº”ç”¨
	@echo "$(BLUE)â–¶ï¸ ç›´æ¥è¿è¡Œåº”ç”¨...$(RESET)"
	$(PYTHON) app/main.py

# ==================== æµ‹è¯• ====================
test: ## ğŸ§ª è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "$(GREEN)ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•...$(RESET)"
	pytest tests/ -v --cov=app --cov-report=html --cov-report=term-missing
	@echo "$(GREEN)âœ… æµ‹è¯•å®Œæˆ$(RESET)"

test-unit: ## ğŸ”¬ è¿è¡Œå•å…ƒæµ‹è¯•
	@echo "$(BLUE)ğŸ”¬ è¿è¡Œå•å…ƒæµ‹è¯•...$(RESET)"
	pytest tests/unit/ -v

test-integration: ## ğŸ”„ è¿è¡Œé›†æˆæµ‹è¯•
	@echo "$(BLUE)ğŸ”„ è¿è¡Œé›†æˆæµ‹è¯•...$(RESET)"
	pytest tests/integration/ -v

test-e2e: ## ğŸŒ è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
	@echo "$(BLUE)ğŸŒ è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•...$(RESET)"
	pytest tests/e2e/ -v

test-watch: ## ğŸ‘€ ç›‘æ§æµ‹è¯•
	@echo "$(BLUE)ğŸ‘€ ç›‘æ§æµ‹è¯•å˜åŒ–...$(RESET)"
	pytest-watch tests/ --runner "pytest --cov=app"

test-coverage: ## ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
	@echo "$(BLUE)ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š...$(RESET)"
	pytest tests/ --cov=app --cov-report=html --cov-report=xml --cov-report=term
	@echo "$(GREEN)âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ: htmlcov/index.html$(RESET)"

test-performance: ## âš¡ æ€§èƒ½æµ‹è¯•
	@echo "$(BLUE)âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•...$(RESET)"
	pytest tests/performance/ -v --benchmark-only

# ==================== ä»£ç è´¨é‡ ====================
lint: ## ğŸ” è¿è¡Œæ‰€æœ‰ä»£ç æ£€æŸ¥
	@echo "$(GREEN)ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥...$(RESET)"
	@$(MAKE) lint-flake8
	@$(MAKE) lint-mypy
	@$(MAKE) lint-security
	@echo "$(GREEN)âœ… ä»£ç æ£€æŸ¥å®Œæˆ$(RESET)"

lint-flake8: ## ğŸ Flake8ä»£ç é£æ ¼æ£€æŸ¥
	@echo "$(BLUE)ğŸ Flake8æ£€æŸ¥...$(RESET)"
	flake8 app/ tests/ scripts/ --statistics

lint-mypy: ## ğŸ“ MyPyç±»å‹æ£€æŸ¥
	@echo "$(BLUE)ğŸ“ MyPyç±»å‹æ£€æŸ¥...$(RESET)"
	mypy app/ --ignore-missing-imports

lint-security: ## ğŸ”’ å®‰å…¨æ£€æŸ¥
	@echo "$(BLUE)ğŸ”’ å®‰å…¨æ£€æŸ¥...$(RESET)"
	bandit -r app/ -ll
	safety check

format: ## âœ¨ æ ¼å¼åŒ–ä»£ç 
	@echo "$(GREEN)âœ¨ æ ¼å¼åŒ–ä»£ç ...$(RESET)"
	black app/ tests/ scripts/
	isort app/ tests/ scripts/
	@echo "$(GREEN)âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ$(RESET)"

format-check: ## ğŸ‘€ æ£€æŸ¥ä»£ç æ ¼å¼
	@echo "$(BLUE)ğŸ‘€ æ£€æŸ¥ä»£ç æ ¼å¼...$(RESET)"
	black --check app/ tests/ scripts/
	isort --check-only app/ tests/ scripts/

pre-commit: ## ğŸ¯ è¿è¡Œpre-commitæ£€æŸ¥
	@echo "$(BLUE)ğŸ¯ è¿è¡Œpre-commitæ£€æŸ¥...$(RESET)"
	pre-commit run --all-files

pre-commit-install: ## ğŸ“¥ å®‰è£…pre-commité’©å­
	@echo "$(BLUE)ğŸ“¥ å®‰è£…pre-commité’©å­...$(RESET)"
	pre-commit install
	@echo "$(GREEN)âœ… pre-commité’©å­å®‰è£…å®Œæˆ$(RESET)"

# ==================== æ•°æ®åº“ç®¡ç† ====================
db-upgrade: ## ğŸ“ˆ å‡çº§æ•°æ®åº“åˆ°æœ€æ–°ç‰ˆæœ¬
	@echo "$(BLUE)ğŸ“ˆ å‡çº§æ•°æ®åº“...$(RESET)"
	alembic upgrade head
	@echo "$(GREEN)âœ… æ•°æ®åº“å‡çº§å®Œæˆ$(RESET)"

db-downgrade: ## ğŸ“‰ é™çº§æ•°æ®åº“ä¸€ä¸ªç‰ˆæœ¬
	@echo "$(BLUE)ğŸ“‰ é™çº§æ•°æ®åº“...$(RESET)"
	alembic downgrade -1
	@echo "$(GREEN)âœ… æ•°æ®åº“é™çº§å®Œæˆ$(RESET)"

db-migration: ## ğŸ“ åˆ›å»ºæ–°çš„æ•°æ®åº“è¿ç§»
	@echo "$(BLUE)ğŸ“ åˆ›å»ºæ•°æ®åº“è¿ç§»...$(RESET)"
	@read -p "è¿ç§»æè¿°: " desc; \
	alembic revision --autogenerate -m "$$desc"
	@echo "$(GREEN)âœ… è¿ç§»æ–‡ä»¶åˆ›å»ºå®Œæˆ$(RESET)"

db-current: ## ğŸ“ æ˜¾ç¤ºå½“å‰æ•°æ®åº“ç‰ˆæœ¬
	@echo "$(BLUE)ğŸ“ å½“å‰æ•°æ®åº“ç‰ˆæœ¬:$(RESET)"
	alembic current

db-history: ## ğŸ“œ æ˜¾ç¤ºè¿ç§»å†å²
	@echo "$(BLUE)ğŸ“œ è¿ç§»å†å²:$(RESET)"
	alembic history

db-reset: ## ğŸ”„ é‡ç½®æ•°æ®åº“
	@echo "$(YELLOW)âš ï¸ é‡ç½®æ•°æ®åº“å°†åˆ é™¤æ‰€æœ‰æ•°æ®ï¼$(RESET)"
	@read -p "ç¡®è®¤é‡ç½®æ•°æ®åº“? [y/N]: " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		alembic downgrade base && \
		alembic upgrade head && \
		$(PYTHON) app/scripts/init_database.py && \
		echo "$(GREEN)âœ… æ•°æ®åº“é‡ç½®å®Œæˆ$(RESET)"; \
	else \
		echo "$(BLUE)â„¹ï¸ æ•°æ®åº“é‡ç½®å·²å–æ¶ˆ$(RESET)"; \
	fi

db-init: ## ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“æ•°æ®
	@echo "$(BLUE)ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“æ•°æ®...$(RESET)"
	$(PYTHON) app/scripts/init_database.py
	@echo "$(GREEN)âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ$(RESET)"

# ==================== Dockeræ“ä½œ ====================
docker-build: ## ğŸ³ æ„å»ºDockeré•œåƒ
	@echo "$(BLUE)ğŸ³ æ„å»ºåç«¯Dockeré•œåƒ...$(RESET)"
	docker build -t trademaster-backend -f ../docker/backend/Dockerfile .
	@echo "$(GREEN)âœ… Dockeré•œåƒæ„å»ºå®Œæˆ$(RESET)"

docker-run: ## ğŸš€ è¿è¡ŒDockerå®¹å™¨
	@echo "$(BLUE)ğŸš€ è¿è¡Œåç«¯Dockerå®¹å™¨...$(RESET)"
	docker run -p 8000:8000 --env-file .env trademaster-backend

docker-shell: ## ğŸš è¿›å…¥Dockerå®¹å™¨shell
	@echo "$(BLUE)ğŸš è¿›å…¥Dockerå®¹å™¨...$(RESET)"
	docker run -it --rm trademaster-backend /bin/bash

# ==================== å·¥å…·å‘½ä»¤ ====================
deps-check: ## ğŸ“¦ æ£€æŸ¥ä¾èµ–åŒ…
	@echo "$(BLUE)ğŸ“¦ æ£€æŸ¥ä¾èµ–åŒ…...$(RESET)"
	$(PIP) list --outdated
	safety check

deps-update: ## â¬†ï¸ æ›´æ–°ä¾èµ–åŒ…
	@echo "$(BLUE)â¬†ï¸ æ›´æ–°ä¾èµ–åŒ…...$(RESET)"
	$(PIP) list --outdated --format=json | jq -r '.[] | .name' | xargs -I {} $(PIP) install --upgrade {}

freeze: ## ğŸ§Š ç”Ÿæˆrequirements.txt
	@echo "$(BLUE)ğŸ§Š ç”Ÿæˆrequirementsæ–‡ä»¶...$(RESET)"
	$(PIP) freeze > requirements-frozen.txt
	@echo "$(GREEN)âœ… requirements-frozen.txt ç”Ÿæˆå®Œæˆ$(RESET)"

docs: ## ğŸ“š ç”ŸæˆAPIæ–‡æ¡£
	@echo "$(BLUE)ğŸ“š ç”ŸæˆAPIæ–‡æ¡£...$(RESET)"
	$(PYTHON) -c "from app.main import app; import json; print(json.dumps(app.openapi(), indent=2))" > openapi.json
	@echo "$(GREEN)âœ… APIæ–‡æ¡£ç”Ÿæˆå®Œæˆ$(RESET)"

# ==================== ç›‘æ§å’Œè°ƒè¯• ====================
logs: ## ğŸ“œ æŸ¥çœ‹åº”ç”¨æ—¥å¿—
	@echo "$(BLUE)ğŸ“œ æŸ¥çœ‹åº”ç”¨æ—¥å¿—...$(RESET)"
	tail -f logs/dev.log

logs-error: ## ğŸ”¥ æŸ¥çœ‹é”™è¯¯æ—¥å¿—
	@echo "$(BLUE)ğŸ”¥ æŸ¥çœ‹é”™è¯¯æ—¥å¿—...$(RESET)"
	grep -i error logs/dev.log | tail -20

health: ## ğŸ¥ å¥åº·æ£€æŸ¥
	@echo "$(BLUE)ğŸ¥ æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€...$(RESET)"
	@curl -f http://localhost:8000/health || echo "$(RED)âŒ åç«¯æœåŠ¡ä¸å¯ç”¨$(RESET)"

profile: ## ğŸ“Š æ€§èƒ½åˆ†æ
	@echo "$(BLUE)ğŸ“Š è¿è¡Œæ€§èƒ½åˆ†æ...$(RESET)"
	$(PYTHON) -m cProfile -o profile.stats app/main.py
	@echo "$(GREEN)âœ… æ€§èƒ½åˆ†æå®Œæˆ: profile.stats$(RESET)"

# ==================== æ¸…ç†æ“ä½œ ====================
clean: ## ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	@echo "$(GREEN)ğŸ§¹ æ¸…ç†åç«¯ä¸´æ—¶æ–‡ä»¶...$(RESET)"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name "*.pyd" -delete 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	rm -rf build/ dist/ *.egg-info/ .coverage htmlcov/ .pytest_cache/ .mypy_cache/ 2>/dev/null || true
	rm -rf logs/*.log temp/* uploads/temp/* 2>/dev/null || true
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(RESET)"

clean-venv: ## ğŸ—‘ï¸ åˆ é™¤è™šæ‹Ÿç¯å¢ƒ
	@echo "$(YELLOW)âš ï¸ åˆ é™¤è™šæ‹Ÿç¯å¢ƒ...$(RESET)"
	rm -rf $(VENV)
	@echo "$(GREEN)âœ… è™šæ‹Ÿç¯å¢ƒåˆ é™¤å®Œæˆ$(RESET)"

clean-all: ## ğŸ—‘ï¸ å®Œå…¨æ¸…ç†
	@echo "$(YELLOW)âš ï¸ å®Œå…¨æ¸…ç†...$(RESET)"
	@$(MAKE) clean
	@$(MAKE) clean-venv
	@echo "$(GREEN)âœ… å®Œå…¨æ¸…ç†å®Œæˆ$(RESET)"

# ==================== ç”Ÿäº§éƒ¨ç½² ====================
build: ## ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
	@echo "$(GREEN)ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬...$(RESET)"
	$(PYTHON) -m build
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆ$(RESET)"

deploy-check: ## âœ… éƒ¨ç½²å‰æ£€æŸ¥
	@echo "$(BLUE)âœ… éƒ¨ç½²å‰æ£€æŸ¥...$(RESET)"
	@$(MAKE) test
	@$(MAKE) lint
	@$(MAKE) security-audit
	@echo "$(GREEN)âœ… éƒ¨ç½²æ£€æŸ¥é€šè¿‡$(RESET)"

security-audit: ## ğŸ” å®‰å…¨å®¡è®¡
	@echo "$(BLUE)ğŸ” å®‰å…¨å®¡è®¡...$(RESET)"
	bandit -r app/ -f json -o security-report.json || true
	safety check --json --output security-deps.json || true
	@echo "$(GREEN)âœ… å®‰å…¨å®¡è®¡å®Œæˆ$(RESET)"

# ==================== å¤‡ä»½å’Œæ¢å¤ ====================
backup: ## ğŸ’¾ å¤‡ä»½æ•°æ®
	@echo "$(BLUE)ğŸ’¾ å¤‡ä»½æ•°æ®...$(RESET)"
	mkdir -p backups/$(shell date +%Y%m%d_%H%M%S)
	cp -r alembic/versions/ backups/$(shell date +%Y%m%d_%H%M%S)/migrations/
	@echo "$(GREEN)âœ… æ•°æ®å¤‡ä»½å®Œæˆ$(RESET)"

# ==================== è°ƒè¯•å·¥å…· ====================
shell: ## ğŸš å¯åŠ¨Python shell
	@echo "$(BLUE)ğŸš å¯åŠ¨Python shell...$(RESET)"
	$(PYTHON) -i -c "from app.main import app; from app.core.config import get_settings; settings = get_settings()"

ipython: ## ğŸ å¯åŠ¨IPython shell
	@echo "$(BLUE)ğŸ å¯åŠ¨IPython shell...$(RESET)"
	ipython -i -c "from app.main import app; from app.core.config import get_settings; settings = get_settings()"

# ==================== ä¿¡æ¯æ˜¾ç¤º ====================
info: ## â„¹ï¸ æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
	@echo "$(GREEN)ğŸ“‹ TradeMaster Backend é¡¹ç›®ä¿¡æ¯$(RESET)"
	@echo "Pythonç‰ˆæœ¬: $(shell $(PYTHON) --version)"
	@echo "é¡¹ç›®è·¯å¾„: $(PWD)"
	@echo "è™šæ‹Ÿç¯å¢ƒ: $(VENV)"
	@echo "å¹³å°: $(PLATFORM)"
	@echo "é…ç½®æ–‡ä»¶: .env"
	@echo "æœåŠ¡åœ°å€: http://localhost:8000"
	@echo "APIæ–‡æ¡£: http://localhost:8000/docs"

env-info: ## ğŸŒ æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
	@echo "$(BLUE)ğŸŒ ç¯å¢ƒå˜é‡ä¿¡æ¯:$(RESET)"
	@$(PYTHON) -c "from app.core.config import get_settings; settings = get_settings(); print(f'Debug: {settings.DEBUG}'); print(f'Environment: {getattr(settings, \"ENVIRONMENT\", \"development\")}'); print(f'Database: {settings.POSTGRES_SERVER}:{settings.POSTGRES_PORT}/{settings.POSTGRES_DB}')"

# ==================== ç‰¹æ®Šç›®æ ‡ ====================
.PHONY: *